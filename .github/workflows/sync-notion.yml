name: å®šæ—¶åŒæ­¥ Notion æ–‡ç« 

on:
  # å®šæ—¶è§¦å‘ï¼šæ¯å¤©åŒ—äº¬æ—¶é—´ 0 ç‚¹ï¼ˆUTC 16:00ï¼‰
  schedule:
    - cron: '0 16 * * *'

  # æ‰‹åŠ¨è§¦å‘ï¼ˆå¯ä»¥åœ¨ GitHub Actions é¡µé¢æ‰‹åŠ¨è¿è¡Œï¼‰
  workflow_dispatch:

jobs:
  sync-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. è®¾ç½® pnpm
      - name: è®¾ç½® pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      # 3. è®¾ç½® Node.js
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'pnpm'

      # 4. å®‰è£…ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: pnpm install

      # 5. ä» Notion åŒæ­¥æ–‡ç« 
      - name: ä» Notion åŒæ­¥æ–‡ç« 
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        run: pnpm sync-notion

      # 6. æäº¤å¹¶æ¨é€æ›´æ”¹
      - name: æäº¤å¹¶æ¨é€æ›´æ”¹
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # æ·»åŠ  content ç›®å½•çš„æ‰€æœ‰æ›´æ”¹
          git add src/content/

          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --staged --quiet; then
            echo "ğŸ“­ æ²¡æœ‰æ–°æ–‡ç« éœ€è¦åŒæ­¥"
          else
            # æœ‰æ›´æ”¹ï¼Œæäº¤å¹¶æ¨é€
            SYNC_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
            git commit -m "chore: è‡ªåŠ¨åŒæ­¥ Notion æ–‡ç« " -m "ğŸ“ æ–‡ç« å·²ä» Notion è‡ªåŠ¨åŒæ­¥" -m "ğŸ• åŒæ­¥æ—¶é—´: ${SYNC_TIME}" -m "ğŸ¤– ç”± GitHub Actions è‡ªåŠ¨æäº¤"
            git push
            echo "âœ… æˆåŠŸåŒæ­¥å¹¶æ¨é€æ–°æ–‡ç« "
          fi
