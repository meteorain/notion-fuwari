---
import Analytics from '@vercel/analytics/astro'
import "@fontsource/roboto/400.css";
import "@fontsource/roboto/500.css";
import "@fontsource/roboto/700.css";

import { profileConfig, siteConfig, analyticsConfig, aiChatConfig } from "@/config";
import ConfigCarrier from "@components/ConfigCarrier.astro";
import WaveBackground from "@components/misc/WaveBackground.astro";
import ChaosBackground from "@components/misc/ChaosBackground.astro";
import AIChatWidget from "@components/AIChatWidget.svelte";
import {
	AUTO_MODE,
	BANNER_HEIGHT,
	BANNER_HEIGHT_EXTEND,
	BANNER_HEIGHT_HOME,
	DARK_MODE,
	DEFAULT_THEME,
	LIGHT_MODE,
	PAGE_WIDTH,
} from "../constants/constants";
import { defaultFavicons } from "../constants/icon";
import type { Favicon } from "../types/config";
import { url, pathsEqual } from "../utils/url-utils";
import "katex/dist/katex.css";

interface Props {
	title?: string;
	banner?: string;
	image?: string;
	description?: string;
	lang?: string;
	setOGTypeArticle?: boolean;
}

let { title, banner, image, description, lang, setOGTypeArticle } = Astro.props;

// apply a class to the body element to decide the height of the banner, only used for initial page load
// Swup can update the body for each page visit, but it's after the page transition, causing a delay for banner height change
// so use Swup hooks instead to change the height immediately when a link is clicked
const isHomePage = pathsEqual(Astro.url.pathname, url("/"));

// defines global css variables
// why doing this in Layout instead of GlobalStyles: https://github.com/withastro/astro/issues/6728#issuecomment-1502203757
const configHue = siteConfig.themeColor.hue;

// 使用全局横幅配置
banner = siteConfig.banner.src;

const enableBanner = siteConfig.banner.enable;

let pageTitle: string;
if (title) {
	pageTitle = `${title} - ${siteConfig.title}`;
} else {
	if (siteConfig.subtitle && siteConfig.subtitle.trim() !== "") {
		pageTitle = `${siteConfig.title} - ${siteConfig.subtitle}`;
	} else {
		pageTitle = siteConfig.title;
	}
}

// 处理 OG 图片 URL
let ogImageUrl: string;
if (image) {
	// 如果传入了图片路径
	if (image.startsWith('http://') || image.startsWith('https://')) {
		// 已经是完整URL
		ogImageUrl = image;
	} else if (image.startsWith('/')) {
		// 公共目录的绝对路径
		ogImageUrl = new URL(image, Astro.site).href;
	} else {
		// 相对路径暂不处理，使用默认图片
		ogImageUrl = new URL(siteConfig.banner.src, Astro.site).href;
	}
} else {
	// 使用默认横幅作为 OG 图片
	ogImageUrl = new URL(siteConfig.banner.src, Astro.site).href;
}

// Use siteConfig.description as fallback for meta description when no description is provided
if (!description) {
	description = siteConfig.description || pageTitle;
}

const favicons: Favicon[] =
	siteConfig.favicon.length > 0 ? siteConfig.favicon : defaultFavicons;

// const siteLang = siteConfig.lang.replace('_', '-')
if (!lang) {
	lang = `${siteConfig.lang}`;
}
const siteLang = lang.replace("_", "-");

const bannerOffsetByPosition = {
	top: `${BANNER_HEIGHT_EXTEND}vh`,
	center: `${BANNER_HEIGHT_EXTEND / 2}vh`,
	bottom: "0",
};
const bannerOffset =
	bannerOffsetByPosition[siteConfig.banner.position || "center"];
---

<!DOCTYPE html>
<html lang={siteLang} class="bg-[var(--page-bg)] transition text-[14px] md:text-[16px]"
	  data-overlayscrollbars-initialize
>
	<head>

		<title>{pageTitle}</title>

		<meta charset="UTF-8" />
		<meta name="description" content={description}>
		<meta name="author" content={profileConfig.name}>
		{siteConfig.keywords && (
			<meta name="keywords" content={siteConfig.keywords.join(", ")}>
		)}

		<meta property="og:site_name" content={siteConfig.title}>
		<meta property="og:url" content={Astro.url}>
		<meta property="og:title" content={pageTitle}>
		<meta property="og:description" content={description}>
		<meta property="og:image" content={ogImageUrl}>
		{setOGTypeArticle ? (
        <meta property="og:type" content="article" />
        ) : (
        <meta property="og:type" content="website" />
        )}

		<meta name="twitter:card" content="summary_large_image">
		<meta property="twitter:url" content={Astro.url}>
		<meta name="twitter:title" content={pageTitle}>
		<meta name="twitter:description" content={description}>
		<meta name="twitter:image" content={ogImageUrl}>

		<link rel="canonical" href={Astro.url}>

		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />

		{/* <!-- Content Security Policy -->
		<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://giscus.app https://hpic.072103.xyz https://umami.2x.nz https://hm.baidu.com https://www.googletagmanager.com https://www.google-analytics.com https://pagead2.googlesyndication.com https://googleads.g.doubleclick.net https://static.cloudflareinsights.com https://*.adtrafficquality.google; style-src 'self' 'unsafe-inline' https://giscus.app https://fonts.googleapis.com https://api.iconify.design; font-src 'self' https://fonts.gstatic.com https://api.iconify.design; img-src 'self' data: https: http:; connect-src 'self' https://umami.2x.nz https://hm.baidu.com https://www.google-analytics.com https://analytics.google.com https://api.iconify.design https://static.cloudflareinsights.com https://pic.2x.nz https://q2.qlogo.cn https://ep1.adtrafficquality.google https://googleads.g.doubleclick.net; frame-src 'self' https://giscus.app *.bilibili.com https://www.google.com https://googleads.g.doubleclick.net https://support.nodeget.com https://*.adtrafficquality.google; object-src 'none'; base-uri 'self'; form-action 'self';"> */}
		{favicons.map(favicon => (
			<link rel="icon"
				  href={favicon.src.startsWith('/') ? url(favicon.src) : favicon.src}
				  sizes={favicon.sizes}
				  media={favicon.theme && `(prefers-color-scheme: ${favicon.theme})`}
			/>
		))}

		<!-- Set the theme before the page is rendered to avoid a flash -->
		<script is:inline define:vars={{DEFAULT_THEME, LIGHT_MODE, DARK_MODE, AUTO_MODE, BANNER_HEIGHT_EXTEND, PAGE_WIDTH, configHue, forceDarkMode: siteConfig.themeColor.forceDarkMode}}>
			// Force dark mode if configured
			if (forceDarkMode) {
				document.documentElement.classList.add('dark');
				localStorage.setItem('theme', DARK_MODE);
			} else {
				// Load the theme from local storage
				const theme = localStorage.getItem('theme') || DEFAULT_THEME;
				switch (theme) {
					case LIGHT_MODE:
						document.documentElement.classList.remove('dark');
						break
					case DARK_MODE:
						document.documentElement.classList.add('dark');
						break
					case AUTO_MODE:
						if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
							document.documentElement.classList.add('dark');
						} else {
							document.documentElement.classList.remove('dark');
						}
				}
			}

			// Load the hue from local storage
			const hue = localStorage.getItem('hue') || configHue;
			document.documentElement.style.setProperty('--hue', hue);

			// calculate the --banner-height-extend, which needs to be a multiple of 4 to avoid blurry text
			let offset = Math.floor(window.innerHeight * (BANNER_HEIGHT_EXTEND / 100));
			offset = offset - offset % 4;
			document.documentElement.style.setProperty('--banner-height-extend', `${offset}px`);

			// Background image loading detection
			const bgUrl = getComputedStyle(document.documentElement).getPropertyValue('--bg-url').trim();
			const bgEnable = getComputedStyle(document.documentElement).getPropertyValue('--bg-enable').trim();
			
			if (bgUrl && bgUrl !== 'none' && bgEnable === '1') {
				const img = new Image();
				const urlMatch = bgUrl.match(/url\(["']?([^"')]+)["']?\)/);
				if (urlMatch) {
					img.onload = function() {
						// 背景图片完全加载后，显示背景并启用卡片透明效果
						document.body.classList.add('bg-loaded');
						document.documentElement.style.setProperty('--card-bg', 'var(--card-bg-transparent)');
						document.documentElement.style.setProperty('--float-panel-bg', 'var(--float-panel-bg-transparent)');
					};
					img.onerror = function() {
						// Keep cards opaque if background image fails to load
						console.warn('Background image failed to load, keeping cards opaque');
					};
					img.src = urlMatch[1];
				}
			}
		</script>
		<style define:vars={{
			configHue,
			'page-width': `${PAGE_WIDTH}rem`,
			'bg-url': siteConfig.background.src ? `url(${siteConfig.background.src})` : 'none',
			'bg-enable': siteConfig.background.enable ? '1' : '0',
			'bg-position': siteConfig.background.position || 'center',
			'bg-size': siteConfig.background.size || 'cover',
			'bg-repeat': siteConfig.background.repeat || 'no-repeat',
			'bg-attachment': siteConfig.background.attachment || 'fixed',
			'bg-opacity': (siteConfig.background.opacity || 0.3).toString()
		}}>
			:root {
				--bg-url: var(--bg-url);
				--bg-enable: var(--bg-enable);
				--bg-position: var(--bg-position);
				--bg-size: var(--bg-size);
				--bg-repeat: var(--bg-repeat);
				--bg-attachment: var(--bg-attachment);
				--bg-opacity: var(--bg-opacity);
			}
			
			/* Background image configuration */
			body {
				--bg-url: var(--bg-url);
				--bg-enable: var(--bg-enable);
				--bg-position: var(--bg-position);
				--bg-size: var(--bg-size);
				--bg-repeat: var(--bg-repeat);
				--bg-attachment: var(--bg-attachment);
				--bg-opacity: var(--bg-opacity);
			}
			
			body::before {
				content: '' !important;
				position: fixed !important;
				top: 0 !important;
				left: 0 !important;
				width: 100% !important;
				height: 100% !important;
				background-image: var(--bg-url) !important;
				background-position: var(--bg-position) !important;
				background-size: var(--bg-size) !important;
				background-repeat: var(--bg-repeat) !important;
				background-attachment: var(--bg-attachment) !important;
				opacity: 0 !important;
				pointer-events: none !important;
				z-index: -1 !important;
				display: block !important;
				transition: opacity 0.3s ease-in-out !important;
			}
			
			body.bg-loaded::before {
				opacity: calc(var(--bg-opacity) * var(--bg-enable)) !important;
			}
		</style>  <!-- defines global css variables. This will be applied to <html> <body> and some other elements idk why -->

		<slot name="head"></slot>

		<link rel="alternate" type="application/rss+xml" title={profileConfig.name} href={`${Astro.site}rss.xml`}/>

		<!-- 分析和广告脚本（根据配置动态加载） -->

		{/* Umami 云端分析 */}
		{analyticsConfig.umamiCloud?.enable && (
			<script
				defer
				src="https://cloud.umami.is/script.js"
				data-website-id={analyticsConfig.umamiCloud.websiteId}
				data-swup-reload-script="false">
			</script>
		)}

		{/* 百度统计 */}
		{analyticsConfig.baidu?.enable && (
			<script is:inline define:vars={{ baiduId: analyticsConfig.baidu.id }}>
				var _hmt = _hmt || [];
				(function() {
					var hm = document.createElement("script");
					hm.src = "https://hm.baidu.com/hm.js?" + baiduId;
					var s = document.getElementsByTagName("script")[0];
					s.parentNode.insertBefore(hm, s);
				})();
			</script>
		)}

		{/* Microsoft Clarity */}
		{analyticsConfig.clarity?.enable && (
			<script is:inline define:vars={{ clarityId: analyticsConfig.clarity.projectId }}>
				(function(c,l,a,r,i,t,y){
					c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
					t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
					y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
				})(window, document, "clarity", "script", clarityId);
			</script>
		)}

		{/* Google AdSense */}
		{analyticsConfig.googleAdsense?.enable && (
			<>
				<script
					async
					src={`https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=${analyticsConfig.googleAdsense.publisherId}`}
					crossorigin="anonymous"
					data-swup-reload-script="false">
				</script>
				<meta name="google-adsense-account" content={analyticsConfig.googleAdsense.publisherId} />
			</>
		)}

		{/* Google Analytics */}
		{analyticsConfig.googleAnalytics?.enable && (
			<>
				<script
					async
					src={`https://www.googletagmanager.com/gtag/js?id=${analyticsConfig.googleAnalytics.measurementId}`}
					data-swup-reload-script="false">
				</script>
				<script is:inline define:vars={{ gaId: analyticsConfig.googleAnalytics.measurementId }}>
					window.dataLayer = window.dataLayer || [];
					function gtag(){dataLayer.push(arguments);}
					gtag('js', new Date());
					gtag('config', gaId);
				</script>
			</>
		)}

		{/* Cloudflare Web Analytics */}
		{analyticsConfig.cloudflare?.enable && (
			<script
				defer
				src='https://static.cloudflareinsights.com/beacon.min.js'
				data-cf-beacon={JSON.stringify({ token: analyticsConfig.cloudflare.token })}
				data-swup-reload-script="false">
			</script>
		)}
	</head>
	<body class=" min-h-screen transition " class:list={[{"lg:is-home": isHomePage, "enable-banner": enableBanner}]}
		  data-overlayscrollbars-initialize
	>
		<ConfigCarrier></ConfigCarrier>
		<slot />

		<!-- increase the page height during page transition to prevent the scrolling animation from jumping -->
		<div id="page-height-extend" class="hidden h-[300vh]"></div>

		<!-- 域名检测脚本 -->
		<script is:inline define:vars={{officialSites: ["https://chaosyn.com", "https://blog.chaosyn.com"]}}>
			// 域名检测功能
			function checkDomain() {
				try {
					// 获取当前访问的完整URL
					const currentUrl = window.location.href;
					// 获取当前域名
					const currentDomain = window.location.hostname;
					
					// 获取所有官方域名
					const officialDomains = officialSites.map(site => {
						try {
							return new URL(site).hostname;
						} catch (e) {
							return null;
						}
					}).filter(domain => domain !== null);
					
					// 检查当前域名是否为官方域名或本地开发环境
					const isOfficialDomain = officialDomains.includes(currentDomain);
					const isLocalDev = currentDomain === 'localhost' || currentDomain === '127.0.0.1';
					
					// 如果当前域名不是官方域名且不是本地开发环境
					if (!isOfficialDomain && !isLocalDev) {
						// 创建警告弹窗
						const shouldRedirect = confirm(
							`⚠️ 域名安全警告\n\n` +
							`您当前访问的域名：${currentDomain}\n` +
							`官方域名：${officialDomains.join(', ')}\n\n` +
							`您可能正在访问非官方网站，存在安全风险！\n\n` +
							`点击"确定"跳转到官方网站\n` +
							`点击"取消"继续访问当前网站（不推荐）`
						);
						
						// 如果用户选择跳转到官方网站
						if (shouldRedirect) {
							// 构建官方网站的对应页面URL（使用第一个官方网站）
							const currentPath = window.location.pathname + window.location.search + window.location.hash;
							const officialPageUrl = officialSites[0] + currentPath;
							// 跳转到官方网站
							window.location.href = officialPageUrl;
						}
					}
				} catch (error) {
					// 如果检测过程中出现错误，静默处理，不影响正常访问
					console.warn('域名检测失败:', error);
				}
			}
			
			// 页面加载完成后执行域名检测
			if (document.readyState === 'loading') {
				document.addEventListener('DOMContentLoaded', checkDomain);
			} else {
				checkDomain();
			}
		</script>

		<!-- Umami 统计工具函数 -->
		<script is:inline>
			// Umami Share Data 缓存
			const UMAMI_CACHE_KEY = 'umami_share_data';
			const UMAMI_CACHE_DURATION = 24 * 60 * 60 * 1000; // 24小时

			// 获取 Umami 分享数据（websiteId 和 token）
			async function getUmamiShareData(baseUrl, shareId) {
				// 尝试从缓存获取
				const cached = localStorage.getItem(UMAMI_CACHE_KEY);
				if (cached) {
					const { data, timestamp } = JSON.parse(cached);
					const age = Date.now() - timestamp;
					if (age < UMAMI_CACHE_DURATION) {
						return data;
					}
				}

				// 缓存失效或不存在，重新获取
				const shareUrl = `${baseUrl}/analytics/us/api/share/${shareId}`;
				const response = await fetch(shareUrl);

				if (!response.ok) {
					throw new Error(`获取 Umami 分享数据失败: ${response.statusText}`);
				}

				const data = await response.json();

				// 缓存数据
				localStorage.setItem(UMAMI_CACHE_KEY, JSON.stringify({
					data,
					timestamp: Date.now()
				}));

				return data;
			}

			// 清理 Umami 缓存
			function clearUmamiShareCache() {
				localStorage.removeItem(UMAMI_CACHE_KEY);
			}

			// 将函数暴露到全局作用域
			window.getUmamiShareData = getUmamiShareData;
			window.clearUmamiShareCache = clearUmamiShareCache;
		</script>

{siteConfig.waveBackground.enable && (
	<WaveBackground />
)}

{siteConfig.chaosBackground.enable && (
	<ChaosBackground />
)}

<Analytics />

<!-- AI 聊天窗口 -->
{aiChatConfig.enable && (
	<AIChatWidget client:load />
)}

	</body>
</html>

<style is:global define:vars={{
	bannerOffset,
	'banner-height-home': `${BANNER_HEIGHT_HOME}vh`,
	'banner-height': `${BANNER_HEIGHT}vh`,
}}>
@tailwind components;
@layer components {
	.enable-banner.is-home #banner-wrapper {
		@apply h-[var(--banner-height-home)] translate-y-[var(--banner-height-extend)]
	}
	.enable-banner #banner-wrapper {
		@apply h-[var(--banner-height-home)]
	}

	.enable-banner.is-home #banner {
		@apply h-[var(--banner-height-home)] translate-y-0
	}
	.enable-banner #banner {
		@apply h-[var(--banner-height-home)] translate-y-[var(--bannerOffset)]
	}
	.enable-banner.is-home #main-grid {
		@apply translate-y-[var(--banner-height-extend)];
	}
	.enable-banner #top-row {
		@apply h-[calc(var(--banner-height-home)_-_4.5rem)] transition-all duration-300
	}
	.enable-banner.is-home #sidebar-sticky {
		@apply top-[calc(1rem_-_var(--banner-height-extend))]
	}
	.navbar-hidden {
		@apply opacity-0 -translate-y-16
	}
}
</style>

<script>
import 'overlayscrollbars/overlayscrollbars.css';
import {
	OverlayScrollbars,
	// ScrollbarsHidingPlugin,
	// SizeObserverPlugin,
	// ClickScrollPlugin
} from 'overlayscrollbars';
import {getHue, getStoredTheme, setHue, setTheme} from "../utils/setting-utils";
import {pathsEqual, url} from "../utils/url-utils";
import {
	BANNER_HEIGHT,
	BANNER_HEIGHT_HOME,
	BANNER_HEIGHT_EXTEND,
	MAIN_PANEL_OVERLAPS_BANNER_HEIGHT
} from "../constants/constants";
import { siteConfig } from '../config';

/* Preload fonts */
// (async function() {
// 	try {
// 		await Promise.all([
// 			document.fonts.load("400 1em Roboto"),
// 			document.fonts.load("700 1em Roboto"),
// 		]);
// 		document.body.classList.remove("hidden");
// 	} catch (error) {
// 		console.log("Failed to load fonts:", error);
// 	}
// })();

/* TODO This is a temporary solution for style flicker issue when the transition is activated */
/* issue link: https://github.com/withastro/astro/issues/8711, the solution get from here too */
/* update: fixed in Astro 3.2.4 */
/*
function disableAnimation() {
	const css = document.createElement('style')
	css.appendChild(
		document.createTextNode(
			`*{
              -webkit-transition:none!important;
              -moz-transition:none!important;
              -o-transition:none!important;
              -ms-transition:none!important;
              transition:none!important
              }`
		)
	)
	document.head.appendChild(css)

	return () => {
		// Force restyle
		;(() => window.getComputedStyle(document.body))()

		// Wait for next tick before removing
		setTimeout(() => {
			document.head.removeChild(css)
		}, 1)
	}
}
*/

const bannerEnabled = !!document.getElementById('banner-wrapper')

// 防止重复注册事件监听器的标志
if (!window.__fuwariInitialized) {
	window.__fuwariInitialized = true;

	function setClickOutsideToClose(panel: string, ignores: string[]) {
		document.addEventListener("click", event => {
			let panelDom = document.getElementById(panel);
			let tDom = event.target;
			if (!(tDom instanceof Node)) return;		// Ensure the event target is an HTML Node
			for (let ig of ignores) {
				let ie = document.getElementById(ig)
				if (ie == tDom || (ie?.contains(tDom))) {
					return;
				}
			}
			panelDom!.classList.add("float-panel-closed");
		});
	}
	setClickOutsideToClose("display-setting", ["display-setting", "display-settings-switch"])
	setClickOutsideToClose("nav-menu-panel", ["nav-menu-panel", "nav-menu-switch"])
	setClickOutsideToClose("search-panel", ["search-panel", "search-bar", "search-switch"])
}


function loadTheme() {
	const theme = getStoredTheme()
	setTheme(theme)
}

function loadHue() {
	setHue(getHue())
}

function initCustomScrollbar() {
	const bodyElement = document.querySelector('body');
	if (!bodyElement) return;
	OverlayScrollbars(
		// docs say that a initialization to the body element would affect native functionality like window.scrollTo
		// but just leave it here for now
		{
			target: bodyElement,
			cancel: {
				nativeScrollbarsOverlaid: true,    // don't initialize the overlay scrollbar if there is a native one
			}
		}, {
		scrollbars: {
			theme: 'scrollbar-base scrollbar-auto py-1',
			autoHide: 'move',
			autoHideDelay: 500,
			autoHideSuspend: false,
		},
	});

	const katexElements = document.querySelectorAll('.katex-display') as NodeListOf<HTMLElement>;
	katexElements.forEach((ele) => {
		OverlayScrollbars(ele, {
			scrollbars: {
				theme: 'scrollbar-base scrollbar-auto py-1',
			}
		});
	});
}

function showBanner() {
	if (!siteConfig.banner.enable) return;

	const banner = document.getElementById('banner');
	if (!banner) {
		console.error('Banner element not found');
		return;
	}

	banner.classList.remove('opacity-0', 'scale-105');
}

function init() {
	// disableAnimation()()		// TODO
	loadTheme();
	loadHue();
	initCustomScrollbar();
	showBanner();
}

/* Load settings when entering the site */
init();

// 防止重复注册 Swup hooks
const setup = () => {
	// TODO: temp solution to change the height of the banner
/*
	window.swup.hooks.on('animation:out:start', () => {
		const path = window.location.pathname
		const body = document.querySelector('body')
		if (path[path.length - 1] === '/' && !body.classList.contains('is-home')) {
			body.classList.add('is-home')
		} else if (path[path.length - 1] !== '/' && body.classList.contains('is-home')) {
			body.classList.remove('is-home')
		}
	})
*/
	window.swup.hooks.on('link:click', () => {
		// Remove the delay for the first time page load
		document.documentElement.style.setProperty('--content-delay', '0ms')

		// prevent elements from overlapping the navbar
		if (!bannerEnabled) {
			return
		}
		let threshold = window.innerHeight * (BANNER_HEIGHT / 100) - 72 - 16
		let navbar = document.getElementById('navbar-wrapper')
		if (!navbar || !document.body.classList.contains('lg:is-home')) {
			return
		}
		if (document.body.scrollTop >= threshold || document.documentElement.scrollTop >= threshold) {
			navbar.classList.add('navbar-hidden')
		}
	})
	window.swup.hooks.on('content:replace', initCustomScrollbar)
	window.swup.hooks.on('visit:start', (visit: {to: {url: string}}) => {
		// change banner height immediately when a link is clicked
		const bodyElement = document.querySelector('body')
		if (pathsEqual(visit.to.url, url('/'))) {
			bodyElement!.classList.add('lg:is-home');
		} else {
			bodyElement!.classList.remove('lg:is-home');
		}

		// increase the page height during page transition to prevent the scrolling animation from jumping
		const heightExtend = document.getElementById('page-height-extend')
		if (heightExtend) {
			heightExtend.classList.remove('hidden')
		}

		// Hide the TOC while scrolling back to top
		let toc = document.getElementById('toc-wrapper');
		if (toc) {
			toc.classList.add('toc-not-ready')
		}
	});
	window.swup.hooks.on('page:view', () => {
		// hide the temp high element when the transition is done
		const heightExtend = document.getElementById('page-height-extend')
		if (heightExtend) {
			heightExtend.classList.remove('hidden')
		}
	});
	window.swup.hooks.on('visit:end', (_visit: {to: {url: string}}) => {
		setTimeout(() => {
			const heightExtend = document.getElementById('page-height-extend')
			if (heightExtend) {
				heightExtend.classList.add('hidden')
			}

            // Just make the transition looks better
            const toc = document.getElementById('toc-wrapper');
            if (toc) {
                toc.classList.remove('toc-not-ready')
            }
        }, 200)
	});
}
// 只在首次初始化时注册 Swup hooks
if (window?.swup?.hooks && !window.__fuwariSwupInitialized) {
	window.__fuwariSwupInitialized = true;
	setup()
} else if (!window.__fuwariSwupInitialized) {
	document.addEventListener('swup:enable', () => {
		if (!window.__fuwariSwupInitialized) {
			window.__fuwariSwupInitialized = true;
			setup();
		}
	})
}

let backToTopBtn = document.getElementById('back-to-top-btn');
let toc = document.getElementById('toc-wrapper');
let navbar = document.getElementById('navbar-wrapper')
function scrollFunction() {
	let bannerHeight = window.innerHeight * (BANNER_HEIGHT / 100)

	if (backToTopBtn) {
		if (document.body.scrollTop > bannerHeight || document.documentElement.scrollTop > bannerHeight) {
			backToTopBtn.classList.remove('hide')
		} else {
			backToTopBtn.classList.add('hide')
		}
	}

	if (bannerEnabled && toc) {
		if (document.body.scrollTop > bannerHeight || document.documentElement.scrollTop > bannerHeight) {
			toc.classList.remove('toc-hide')
		} else {
			toc.classList.add('toc-hide')
		}
	}

	if (!bannerEnabled) return
	if (navbar) {
		const NAVBAR_HEIGHT = 72
		const MAIN_PANEL_EXCESS_HEIGHT = MAIN_PANEL_OVERLAPS_BANNER_HEIGHT * 16			// The height the main panel overlaps the banner

		let bannerHeight = BANNER_HEIGHT
		if (document.body.classList.contains('lg:is-home') && window.innerWidth >= 1024) {
			bannerHeight = BANNER_HEIGHT_HOME
		}
		let threshold = window.innerHeight * (bannerHeight / 100) - NAVBAR_HEIGHT - MAIN_PANEL_EXCESS_HEIGHT - 16
		if (document.body.scrollTop >= threshold || document.documentElement.scrollTop >= threshold) {
			navbar.classList.add('navbar-hidden')
		} else {
			navbar.classList.remove('navbar-hidden')
		}
	}
}
window.onscroll = scrollFunction

window.onresize = () => {
	// calculate the --banner-height-extend, which needs to be a multiple of 4 to avoid blurry text
	let offset = Math.floor(window.innerHeight * (BANNER_HEIGHT_EXTEND / 100));
	offset = offset - offset % 4;
	document.documentElement.style.setProperty('--banner-height-extend', `${offset}px`);
}

</script>

<script>
import { Fancybox } from "@fancyapps/ui"
import "@fancyapps/ui/dist/fancybox/fancybox.css"

const setup = () => {
	Fancybox.bind(".custom-md img, #post-cover img", {
		wheel: 'zoom',
		clickContent: 'close',
		dblclickContent: 'zoom',
		click: 'close',
		dblclick: 'zoom',
		Panels: {
			display: ['counter', 'zoom']
		},
		Images: {
			panning: true,
			zoom: true,
			protect: false
		}
	})

	window.swup.hooks.on("page:view", () => {
		Fancybox.bind(".custom-md img, #post-cover img", {
			wheel: 'zoom',
			clickContent: 'close',
			dblclickContent: 'zoom',
			click: 'close',
			dblclick: 'zoom',
			Panels: {
				display: ['counter', 'zoom']
			},
			Images: {
				panning: true,
				zoom: true,
				protect: false
			}
		})
	})

	window.swup.hooks.on(
		"content:replace",
		() => {
			Fancybox.unbind(".custom-md img, #post-cover img")
		},
		{ before: true },
	)
}

// 防止重复初始化 Fancybox
if (window.swup && !window.__fuwariFancyboxInitialized) {
	window.__fuwariFancyboxInitialized = true;
	setup()
} else if (!window.__fuwariFancyboxInitialized) {
	document.addEventListener("swup:enable", () => {
		if (!window.__fuwariFancyboxInitialized) {
			window.__fuwariFancyboxInitialized = true;
			setup();
		}
	})
}
</script>

<!-- 客户端国际化脚本 -->
<script is:inline>
	// 客户端国际化更新脚本
	(function() {
		// 导入翻译数据（内联）
		const locales = ['zh-CN', 'en'];
		const localeNames = {
			'zh-CN': '简体中文',
			'en': 'English'
		};
		const translations = {
			'zh-CN': {
				nav: {
					'home': '首页',
					'archive': '归档',
					'about': '关于',
					'friends': '友链',
					'sponsors': '赞助',
					'statistics': '统计',
					'status': '状态'
				},
				common: {
					'noTags': '无标签',
					'prevPage': '上一页',
					'nextPage': '下一页',
					'backToTop': '返回顶部',
					'page': '第',
					'tags': '标签',
					'search': '搜索',
					'more': '更多'
				},
				post: {
					'publishedAt': '发布于',
					'updatedAt': '更新于',
					'author': '作者',
					'license': '许可协议',
					'minutes': '分钟',
					'words': '字'
				},
				stats: {
					'views': '浏览',
					'visitors': '访客',
					'loading': '统计加载中...',
					'error': '统计不可用。请检查是否屏蔽了Umami域名，如AdGuard和AdBlock等插件'
				},
				footer: {
					'licensed': '采用',
					'license': '许可',
					'rss': 'RSS',
					'sitemap': '站点地图',
					'poweredBy': '由',
					'and': '和',
					'powered': '驱动',
					'codeOpenSource': '代码开源，',
					'isOpenSource': '开源'
				},
				archive: {
					'title': '归档',
					'allPosts': '所有文章',
					'tags': '标签'
				},
				page: {
					'about': '关于',
					'friends': '友链',
					'sponsors': '赞助'
				},
				notFound: {
					'title': '页面未找到',
					'description': '抱歉，您访问的页面不存在或已被移动。',
					'suggestion': '建议您检查网址是否正确，或使用下面的导航按钮返回。',
					'home': '返回首页',
					'archive': '文章归档'
				}
			},
			'en': {
				nav: {
					'home': 'Home',
					'archive': 'Archive',
					'about': 'About',
					'friends': 'Friends',
					'sponsors': 'Sponsors',
					'statistics': 'Stats',
					'status': 'Status'
				},
				common: {
					'noTags': 'No Tags',
					'prevPage': 'Previous',
					'nextPage': 'Next',
					'backToTop': 'Back to Top',
					'page': 'Page',
					'tags': 'Tags',
					'search': 'Search',
					'more': 'More'
				},
				post: {
					'publishedAt': 'Published',
					'updatedAt': 'Updated',
					'author': 'Author',
					'license': 'License',
					'minutes': 'min',
					'words': 'words'
				},
				stats: {
					'views': 'Views',
					'visitors': 'Visitors',
					'loading': 'Loading stats...',
					'error': 'Stats unavailable. Please check if Umami domain is blocked by AdGuard or AdBlock extensions'
				},
				footer: {
					'licensed': 'Licensed under',
					'license': 'License',
					'rss': 'RSS',
					'sitemap': 'Sitemap',
					'poweredBy': 'Powered by',
					'and': 'and',
					'powered': '',
					'codeOpenSource': 'Code is open source,',
					'isOpenSource': 'open source'
				},
				archive: {
					'title': 'Archive',
					'allPosts': 'All Posts',
					'tags': 'Tags'
				},
				page: {
					'about': 'About',
					'friends': 'Friends',
					'sponsors': 'Sponsors'
				},
				notFound: {
					'title': 'Page Not Found',
					'description': 'Sorry, the page you are looking for does not exist or has been moved.',
					'suggestion': 'Please check if the URL is correct, or use the navigation buttons below to return.',
					'home': 'Back to Home',
					'archive': 'Archive'
				}
			}
		};

		// 翻译函数
		function t(key, locale, params) {
			const currentLocale = locale || getCurrentLocale();
			const keys = key.split(".");

			let value = translations[currentLocale];

			for (const k of keys) {
				if (value && typeof value === "object" && k in value) {
					value = value[k];
				} else {
					console.warn(`Translation not found: ${key} for locale ${currentLocale}`);
					return key;
				}
			}

			// 简单的参数替换
			if (params && typeof value === "string") {
				for (const [k, v] of Object.entries(params)) {
					value = value.replace(new RegExp(`{${k}}`, 'g'), v);
				}
			}

			return value;
		}

		// 获取当前语言偏好
		function getCurrentLocale() {
			if (typeof localStorage !== 'undefined') {
				const preferredLocale = localStorage.getItem('preferred-locale');
				console.log('getCurrentLocale - from localStorage:', preferredLocale);
				if (preferredLocale && locales.includes(preferredLocale)) {
					console.log('getCurrentLocale - returning:', preferredLocale);
					return preferredLocale;
				}
			}
			console.log('getCurrentLocale - returning default: zh-CN');
			return 'zh-CN'; // 默认语言
		}

		// 更新页面翻译
		function updatePageTranslations() {
			const currentLocale = getCurrentLocale();
			console.log('updatePageTranslations called with locale:', currentLocale);

			// 更新导航栏文本
			const navLinks = document.querySelectorAll('[data-i18n-key]');
			navLinks.forEach((element) => {
				const key = element.dataset.i18nKey;
				if (key) {
					const translation = t(key, currentLocale);
					if (element.children.length === 0) {
						element.textContent = translation;
					} else {
						const textNode = Array.from(element.childNodes).find(
							node => node.nodeType === Node.TEXT_NODE
						);
						if (textNode) {
							textNode.textContent = translation;
						}
					}
				}
			});

			// 更新页脚文本
			const footerLicensed = document.querySelector('[data-i18n-footer="licensed"]');
			if (footerLicensed) footerLicensed.textContent = t('footer.licensed', currentLocale);

			const footerLicense = document.querySelector('[data-i18n-footer="license"]');
			if (footerLicense) footerLicense.textContent = t('footer.license', currentLocale);

			const footerRss = document.querySelector('[data-i18n-footer="rss"]');
			if (footerRss) footerRss.textContent = t('footer.rss', currentLocale);

			const footerSitemap = document.querySelector('[data-i18n-footer="sitemap"]');
			if (footerSitemap) footerSitemap.textContent = t('footer.sitemap', currentLocale);

			const footerPoweredBy = document.querySelector('[data-i18n-footer="poweredBy"]');
			if (footerPoweredBy) footerPoweredBy.textContent = t('footer.poweredBy', currentLocale);

			const footerAnd = document.querySelector('[data-i18n-footer="and"]');
			if (footerAnd) footerAnd.textContent = t('footer.and', currentLocale);

			const footerPowered = document.querySelector('[data-i18n-footer="powered"]');
			if (footerPowered) footerPowered.textContent = t('footer.powered', currentLocale);

			const footerCodeOpenSource = document.querySelector('[data-i18n-footer="codeOpenSource"]');
			if (footerCodeOpenSource) footerCodeOpenSource.textContent = t('footer.codeOpenSource', currentLocale);

			const footerIsOpenSource = document.querySelector('[data-i18n-footer="isOpenSource"]');
			if (footerIsOpenSource) footerIsOpenSource.textContent = t('footer.isOpenSource', currentLocale);

			// 更新 PostMeta 文本
			const metaElements = document.querySelectorAll('[data-i18n-meta]');
			metaElements.forEach((element) => {
				const type = element.dataset.i18nMeta;
				if (type === 'noTags') {
					element.textContent = t('common.noTags', currentLocale);
				}
			});

			// 更新分页文本
			const paginationPrev = document.querySelector('[data-i18n-pagination="prev"]');
			if (paginationPrev) paginationPrev.textContent = t('common.prevPage', currentLocale);

			const paginationNext = document.querySelector('[data-i18n-pagination="next"]');
			if (paginationNext) paginationNext.textContent = t('common.nextPage', currentLocale);

			// 更新回到顶部文本
			const backToTop = document.querySelector('[data-i18n="backToTop"]');
			if (backToTop) backToTop.textContent = t('common.backToTop', currentLocale);

			// 更新归档文本
			const archiveTitle = document.querySelector('[data-i18n-archive="title"]');
			if (archiveTitle) archiveTitle.textContent = t('archive.title', currentLocale);

			const archiveAllPosts = document.querySelector('[data-i18n-archive="allPosts"]');
			if (archiveAllPosts) archiveAllPosts.textContent = t('archive.allPosts', currentLocale);

			const archiveTags = document.querySelector('[data-i18n-archive="tags"]');
			if (archiveTags) archiveTags.textContent = t('archive.tags', currentLocale);

			// 更新页面标题
			const pageTitleElements = document.querySelectorAll('[data-i18n-page="title"]');
			pageTitleElements.forEach((element) => {
				const key = element.getAttribute('data-i18n-page-key');
				if (key) {
					element.textContent = t(key, currentLocale);
				}
			});

			// 更新404页面其他元素
			const notFoundHomeElements = document.querySelectorAll('[data-i18n-page="home"]');
			notFoundHomeElements.forEach((element) => {
				const key = element.getAttribute('data-i18n-page-key');
				if (key) {
					element.textContent = t(key, currentLocale);
				}
			});

			const notFoundArchiveElements = document.querySelectorAll('[data-i18n-page="archive"]');
			notFoundArchiveElements.forEach((element) => {
				const key = element.getAttribute('data-i18n-page-key');
				if (key) {
					element.textContent = t(key, currentLocale);
				}
			});

			// 更新 WidgetLayout 名称（侧边栏组件）
			const widgetElements = document.querySelectorAll('[data-i18n-widget="tags"]');
			widgetElements.forEach((element) => {
				element.setAttribute('name', t('common.tags', currentLocale));
			});

			// 更新 WidgetLayout 中的"更多"按钮文本
			const moreElements = document.querySelectorAll('[data-i18n-widget="more"]');
			moreElements.forEach((element) => {
				element.textContent = t('common.more', currentLocale);
			});

			// 更新 License 组件文本
			const licenseAuthor = document.querySelector('[data-i18n-license="author"]');
			if (licenseAuthor) licenseAuthor.textContent = t('post.author', currentLocale);

			const licensePublishedAt = document.querySelector('[data-i18n-license="publishedAt"]');
			if (licensePublishedAt) licensePublishedAt.textContent = t('post.publishedAt', currentLocale);

			const licenseLicense = document.querySelector('[data-i18n-license="license"]');
			if (licenseLicense) licenseLicense.textContent = t('post.license', currentLocale);

			// 更新文章卡片和文章页面的"字"和"分钟"文本
			const postWordsElements = document.querySelectorAll('[data-i18n-post="words"]');
			postWordsElements.forEach((element) => {
				element.textContent = t('post.words', currentLocale);
			});

			const postMinutesElements = document.querySelectorAll('[data-i18n-post="minutes"]');
			postMinutesElements.forEach((element) => {
				element.textContent = t('post.minutes', currentLocale);
			});

			// 更新标签组件的标题
			document.querySelectorAll('[data-i18n-widget="tags"]').forEach((element) => {
				// 找到父元素中的标题div
				const titleDiv = element.querySelector('.font-bold');
				if (titleDiv) {
					titleDiv.textContent = t('common.tags', currentLocale);
				}
			});

			// 更新统计加载文本
			const statsLoadingElements = document.querySelectorAll('[data-i18n-stats="loading"]');
			statsLoadingElements.forEach((element) => {
				// 只更新还在显示"加载中"状态的元素
				const text = element.textContent || '';
				if (text.includes('加载中') || text.includes('Loading')) {
					element.textContent = t('stats.loading', currentLocale);
				}
			});
		}

		// 页面加载完成后执行
		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', updatePageTranslations);
		} else {
			updatePageTranslations();
		}

		// 处理 Astro 的页面切换事件
		document.addEventListener('astro:after-swap', updatePageTranslations);
	})();
</script>
