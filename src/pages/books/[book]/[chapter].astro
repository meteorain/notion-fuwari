---
import MainGridLayout from "@layouts/MainGridLayout.astro";
import Markdown from "@components/misc/Markdown.astro";
import { getBooks, getBookChapters, getBookBySlug, type BookChapter } from "@utils/content-utils";
import { Icon } from "astro-icon/components";

export async function getStaticPaths() {
	const books = await getBooks();
	const paths = [];

	for (const book of books) {
		const chapters = await getBookChapters(book.slug);
		for (const chapter of chapters) {
			paths.push({
				params: { book: book.slug, chapter: chapter.chapterSlug },
				props: { bookSlug: book.slug, chapter },
			});
		}
	}

	return paths;
}

interface Props {
	bookSlug: string;
	chapter: BookChapter;
}

const { bookSlug, chapter } = Astro.props;
const book = await getBookBySlug(bookSlug);

if (!book) {
	return Astro.redirect('/books/');
}

const { Content, headings } = await chapter.render();
---
<MainGridLayout title={`${chapter.title} - ${book.title}`} description={book.description} headings={headings} hideSidebar={true}>
	<div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative mb-4">
		<div class="card-base z-10 px-6 md:px-9 py-6 relative w-full">
			<!-- 面包屑导航 -->
			<nav class="flex items-center gap-2 text-sm text-black/50 dark:text-white/50 mb-4 flex-wrap">
				<a href="/books/" class="hover:text-[var(--primary)] transition-colors">图书</a>
				<Icon name="material-symbols:chevron-right" class="text-base flex-shrink-0" />
				<a href={`/books/${bookSlug}/`} class="hover:text-[var(--primary)] transition-colors">{book.title}</a>
				<Icon name="material-symbols:chevron-right" class="text-base flex-shrink-0" />
				<span class="text-black/70 dark:text-white/70">{chapter.title}</span>
			</nav>

			<!-- 章节标题 -->
			<div class="mb-6">
				<div class="flex items-center gap-2 text-sm text-black/50 dark:text-white/50 mb-2">
					<span>第 {chapter.order} 章</span>
				</div>
				<h1 class="text-2xl md:text-3xl font-bold text-black/90 dark:text-white/90">
					{chapter.title}
				</h1>
			</div>

			<!-- 章节内容 -->
			<div class="border-t border-[var(--line-divider)] pt-6 mb-6">
				<Markdown class="markdown-content">
					<Content />
				</Markdown>
			</div>

			<!-- 章节导航 -->
			<div class="border-t border-[var(--line-divider)] pt-6">
				<div class="flex flex-col sm:flex-row justify-between gap-4">
					{chapter.prevChapter ? (
						<a
							href={`/books/${bookSlug}/${chapter.prevChapter.slug}/`}
							class="flex-1 group"
						>
							<div class="btn-card rounded-xl p-4 h-full flex items-center gap-3">
								<Icon name="material-symbols:chevron-left-rounded" class="text-2xl text-[var(--primary)] flex-shrink-0" />
								<div class="min-w-0">
									<div class="text-xs text-black/50 dark:text-white/50 mb-1">上一章</div>
									<div class="text-black/80 dark:text-white/80 group-hover:text-[var(--primary)] transition-colors truncate">
										{chapter.prevChapter.title}
									</div>
								</div>
							</div>
						</a>
					) : (
						<div class="flex-1"></div>
					)}

					<a
						href={`/books/${bookSlug}/`}
						class="flex-shrink-0"
					>
						<div class="btn-card rounded-xl p-4 h-full flex items-center justify-center gap-2">
							<Icon name="material-symbols:list" class="text-xl text-[var(--primary)]" />
							<span class="text-black/80 dark:text-white/80">目录</span>
						</div>
					</a>

					{chapter.nextChapter ? (
						<a
							href={`/books/${bookSlug}/${chapter.nextChapter.slug}/`}
							class="flex-1 group"
						>
							<div class="btn-card rounded-xl p-4 h-full flex items-center justify-end gap-3">
								<div class="min-w-0 text-right">
									<div class="text-xs text-black/50 dark:text-white/50 mb-1">下一章</div>
									<div class="text-black/80 dark:text-white/80 group-hover:text-[var(--primary)] transition-colors truncate">
										{chapter.nextChapter.title}
									</div>
								</div>
								<Icon name="material-symbols:chevron-right-rounded" class="text-2xl text-[var(--primary)] flex-shrink-0" />
							</div>
						</a>
					) : (
						<div class="flex-1"></div>
					)}
				</div>
			</div>
		</div>
	</div>
</MainGridLayout>
