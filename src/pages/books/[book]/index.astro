---
import MainGridLayout from "@layouts/MainGridLayout.astro";
import Markdown from "@components/misc/Markdown.astro";
import { getBooks, getBookChapters, type Book } from "@utils/content-utils";
import { Icon } from "astro-icon/components";

export async function getStaticPaths() {
	const books = await getBooks();
	return books.map((book) => ({
		params: { book: book.slug },
		props: { book },
	}));
}

interface Props {
	book: Book;
}

const { book } = Astro.props;
const chapters = await getBookChapters(book.slug);
const { Content } = await book.render();

const statusMap = {
	ongoing: { text: '连载中', color: 'bg-blue-500/20 text-blue-600 dark:text-blue-400' },
	completed: { text: '已完结', color: 'bg-green-500/20 text-green-600 dark:text-green-400' },
	paused: { text: '暂停中', color: 'bg-yellow-500/20 text-yellow-600 dark:text-yellow-400' },
};
const status = statusMap[book.status];
---
<MainGridLayout title={book.title} description={book.description} hideSidebar={true}>
	<div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative mb-4">
		<div class="card-base z-10 px-6 md:px-9 py-6 relative w-full">
			<!-- 面包屑导航 -->
			<nav class="flex items-center gap-2 text-sm text-black/50 dark:text-white/50 mb-4">
				<a href="/books/" class="hover:text-[var(--primary)] transition-colors">图书</a>
				<Icon name="material-symbols:chevron-right" class="text-base" />
				<span class="text-black/70 dark:text-white/70">{book.title}</span>
			</nav>

			<!-- 图书信息头部 -->
			<div class="flex flex-col md:flex-row gap-6 mb-6">
				<div class="flex-shrink-0">
					{book.image ? (
						<img
							src={book.image}
							alt={book.title}
							class="w-full md:w-40 h-52 md:h-56 object-cover rounded-xl shadow-lg"
						/>
					) : (
						<div class="w-full md:w-40 h-52 md:h-56 rounded-xl bg-black/5 dark:bg-white/10 flex items-center justify-center shadow-lg">
							<Icon name="material-symbols:menu-book-outline" class="text-5xl text-black/20 dark:text-white/20" />
						</div>
					)}
				</div>
				<div class="flex-1">
					<div class="flex items-start gap-3 mb-3">
						<h1 class="text-2xl md:text-3xl font-bold text-black/90 dark:text-white/90">
							{book.title}
						</h1>
						<span class={`flex-shrink-0 px-2.5 py-1 text-xs font-medium rounded ${status.color}`}>
							{status.text}
						</span>
					</div>

					<div class="space-y-2 text-sm text-black/70 dark:text-white/70 mb-4">
						{book.author && (
							<div class="flex items-center gap-2">
								<Icon name="material-symbols:person-outline" class="text-base text-black/50 dark:text-white/50" />
								<span>原作: {book.author}</span>
							</div>
						)}
						{book.translator && (
							<div class="flex items-center gap-2">
								<Icon name="material-symbols:translate" class="text-base text-black/50 dark:text-white/50" />
								<span>译者: {book.translator}</span>
							</div>
						)}
						<div class="flex items-center gap-2">
							<Icon name="material-symbols:format-list-numbered" class="text-base text-black/50 dark:text-white/50" />
							<span>共 {chapters.length} 章</span>
						</div>
						{book.updated && (
							<div class="flex items-center gap-2">
								<Icon name="material-symbols:update" class="text-base text-black/50 dark:text-white/50" />
								<span>更新于 {book.updated.toLocaleDateString('zh-CN')}</span>
							</div>
						)}
					</div>

					{book.description && (
						<p class="text-black/70 dark:text-white/70 mb-4">
							{book.description}
						</p>
					)}

					{book.tags.length > 0 && (
						<div class="flex flex-wrap gap-2">
							{book.tags.map((tag) => (
								<span class="px-2.5 py-1 text-xs bg-black/5 dark:bg-white/10 text-black/60 dark:text-white/60 rounded-lg">
									{tag}
								</span>
							))}
						</div>
					)}
				</div>
			</div>

			<!-- 图书简介/前言 -->
			{book.body && (
				<div class="mb-6">
					<div class="border-t border-[var(--line-divider)] pt-6">
						<h2 class="flex items-center gap-2 text-lg font-bold text-black/90 dark:text-white/90 mb-4">
							<Icon name="material-symbols:info-outline" class="text-xl" />
							简介
						</h2>
						<Markdown class="prose-sm">
							<Content />
						</Markdown>
					</div>
				</div>
			)}

			<!-- 章节目录 -->
			<div class="border-t border-[var(--line-divider)] pt-6">
				<h2 class="flex items-center gap-2 text-lg font-bold text-black/90 dark:text-white/90 mb-4">
					<Icon name="material-symbols:list" class="text-xl" />
					目录
				</h2>

				{chapters.length === 0 ? (
					<div class="text-center py-8 text-black/50 dark:text-white/50">
						<p>暂无章节</p>
					</div>
				) : (
					<div class="space-y-2">
						{chapters.map((chapter, index) => (
							<a
								href={`/books/${book.slug}/${chapter.chapterSlug}/`}
								class="group flex items-center gap-3 p-3 rounded-lg hover:bg-black/5 dark:hover:bg-white/5 transition-colors"
							>
								<span class="flex-shrink-0 w-8 h-8 rounded-lg bg-[var(--primary)]/10 text-[var(--primary)] flex items-center justify-center text-sm font-medium">
									{index + 1}
								</span>
								<span class="flex-1 text-black/80 dark:text-white/80 group-hover:text-[var(--primary)] transition-colors">
									{chapter.title}
								</span>
								<Icon name="material-symbols:chevron-right" class="text-xl text-black/30 dark:text-white/30 group-hover:text-[var(--primary)] transition-colors" />
							</a>
						))}
					</div>
				)}
			</div>
		</div>
	</div>
</MainGridLayout>
