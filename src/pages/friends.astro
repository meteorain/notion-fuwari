---
import MainGridLayout from "@layouts/MainGridLayout.astro";
import { Icon } from "astro-icon/components";
import type { FriendsData } from "@/types/data";
import friendsData from "@/data/friends.json";

const { friends } = friendsData as FriendsData;
---

<MainGridLayout title="友链">
    <div class="card-base p-6 md:p-8">
        <div class="flex items-center gap-2 mb-6">
            <div class="h-8 w-8 rounded-lg bg-[var(--primary)] flex items-center justify-center text-white dark:text-black/70">
                <Icon name="material-symbols:diversity-3" class="text-[1.5rem]">
            </div>
            <h1 class="text-2xl font-bold text-black dark:text-white">友链</h1>
        </div>

        <!-- 申请友链（移到最前面） -->
        <div class="apply-section mb-8 p-6 rounded-lg bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 border border-blue-200 dark:border-blue-800">
            <h2 class="text-xl font-bold text-black dark:text-white mb-2 flex items-center gap-2">
                <Icon name="material-symbols:group" class="text-[1.5rem] text-[var(--primary)]"/>
                将您的网站加入本站友链
            </h2>
            <p class="text-sm text-black/60 dark:text-white/60 mb-4">
                欢迎交换友情链接！点击下方按钮即可提交申请
            </p>
            <button
                onclick="document.getElementById('friend-link-modal').classList.remove('hidden'); document.body.style.overflow = 'hidden';"
                class="btn-primary px-6 py-2.5 rounded-lg font-medium transition-all hover:scale-105 active:scale-95">
                <span class="flex items-center gap-2">
                    <Icon name="material-symbols:add-circle-outline" class="text-lg"/>
                    点击这里提交
                </span>
            </button>
        </div>

        <!-- 友链列表 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            {friends.map((friend) => (
                <a href={friend.url} target="_blank" class="friend-card">
                    <div class="flex items-center gap-2">
                        <img src={friend.avatar} loading="lazy" class="w-5 h-5 rounded" alt={`${friend.name}的头像`}>
                        <div class="font-bold text-black dark:text-white">{friend.name}</div>
                    </div>
                    <div class="text-sm text-black/50 dark:text-white/50">{friend.description}</div>
                </a>
            ))}
        </div>
    </div>

    <!-- Toast 通知容器 -->
    <div id="toast-container" class="fixed top-20 right-4 z-[10000] flex flex-col gap-2 pointer-events-none"></div>

    <!-- 友链申请弹窗 -->
    <div id="friend-link-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[9999] flex items-center justify-center hidden py-8 px-4"
         onclick="if (event.target === this) { this.classList.add('hidden'); document.body.style.overflow = ''; document.getElementById('friend-link-form').reset(); }">
        <div class="card-base max-w-lg w-full p-6 md:p-8 animate-modal-appear max-h-[80vh] overflow-y-auto my-auto" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold text-black dark:text-white flex items-center gap-2">
                    <Icon name="material-symbols:link" class="text-[var(--primary)]"/>
                    申请友链
                </h3>
                <button
                    onclick="document.getElementById('friend-link-modal').classList.add('hidden'); document.body.style.overflow = ''; document.getElementById('friend-link-form').reset(); document.getElementById('form-message').classList.add('hidden');"
                    class="text-gray-500 hover:text-black dark:hover:text-white transition-colors">
                    <Icon name="material-symbols:close" class="text-2xl"/>
                </button>
            </div>

            <form id="friend-link-form" class="space-y-4" onsubmit="handleSubmit(event)">
                <div>
                    <label class="block text-sm font-medium text-black dark:text-white mb-2">
                        网站名称 <span class="text-red-500">*</span>
                    </label>
                    <input
                        type="text"
                        name="name"
                        required
                        placeholder="请输入网站名称"
                        class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-black dark:text-white focus:ring-2 focus:ring-[var(--primary)] focus:border-transparent outline-none transition-all"
                    >
                </div>

                <div>
                    <label class="block text-sm font-medium text-black dark:text-white mb-2">
                        网站地址 <span class="text-red-500">*</span>
                    </label>
                    <input
                        type="url"
                        name="url"
                        required
                        placeholder="https://example.com"
                        class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-black dark:text-white focus:ring-2 focus:ring-[var(--primary)] focus:border-transparent outline-none transition-all"
                    >
                </div>

                <div>
                    <label class="block text-sm font-medium text-black dark:text-white mb-2">
                        网站描述 <span class="text-red-500">*</span>
                    </label>
                    <textarea
                        name="description"
                        required
                        rows="3"
                        placeholder="请简单描述你的网站"
                        class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-black dark:text-white focus:ring-2 focus:ring-[var(--primary)] focus:border-transparent outline-none transition-all resize-none"
                    ></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-black dark:text-white mb-2">
                        头像链接 <span class="text-red-500">*</span>
                    </label>
                    <input
                        type="url"
                        name="avatar"
                        required
                        placeholder="https://example.com/avatar.png"
                        class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-black dark:text-white focus:ring-2 focus:ring-[var(--primary)] focus:border-transparent outline-none transition-all"
                    >
                </div>

                <div class="flex gap-3 pt-4 pb-2">
                    <button
                        type="submit"
                        id="submit-btn"
                        class="flex-1 btn-primary px-6 py-2.5 rounded-lg font-medium transition-all hover:scale-105 active:scale-95"
                    >
                        提交申请
                    </button>
                    <button
                        type="button"
                        onclick="document.getElementById('friend-link-modal').classList.add('hidden'); document.body.style.overflow = ''; document.getElementById('friend-link-form').reset();"
                        class="px-6 py-2.5 rounded-lg font-medium text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 transition-all"
                    >
                        取消
                    </button>
                </div>
            </form>
        </div>
    </div>
</MainGridLayout>

<style>
    .friend-card {
        @apply flex flex-col gap-1 p-4 rounded-lg bg-[var(--card-bg)] hover:bg-black/5 dark:hover:bg-white/5;
        transition-property: all;
        transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        transition-duration: 0.15s;
    }

    .friend-card:active {
        scale: .98;
        background-color: var(--btn-regular-bg-active);
    }

    .friend-card:hover {
        background-color: var(--btn-regular-bg-hover);
    }

    .friend-card:hover .font-bold {
        color: var(--btn-content);
    }

    .friend-card:hover .text-sm {
        @apply text-gray-700 dark:text-white;
    }

    .friend-card .font-bold,
    .friend-card .text-sm {
        transition-property: color;
        transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        transition-duration: 0.15s;
    }

    .btn-primary {
        background: var(--primary);
        color: white;
    }

    .btn-primary:hover {
        filter: brightness(1.1);
    }

    @keyframes modal-appear {
        from {
            opacity: 0;
            transform: scale(0.95) translateY(-20px);
        }
        to {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }

    .animate-modal-appear {
        animation: modal-appear 0.2s ease-out;
    }
</style>

<script is:inline>
    // Toast 通知函数
    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');

        // 设置样式
        const bgColor = type === 'success'
            ? 'bg-green-500 dark:bg-green-600'
            : 'bg-red-500 dark:bg-red-600';

        toast.className = `${bgColor} text-white px-6 py-3 rounded-lg shadow-lg pointer-events-auto transform transition-all duration-300 ease-out translate-x-full opacity-0`;
        toast.textContent = message;

        container.appendChild(toast);

        // 触发动画
        requestAnimationFrame(() => {
            requestAnimationFrame(() => {
                toast.classList.remove('translate-x-full', 'opacity-0');
            });
        });

        // 3秒后移除
        setTimeout(() => {
            toast.classList.add('translate-x-full', 'opacity-0');
            setTimeout(() => {
                container.removeChild(toast);
            }, 300);
        }, 3000);
    }

    async function handleSubmit(event) {
        event.preventDefault();

        const form = event.target;
        const submitBtn = document.getElementById('submit-btn');

        const formData = new FormData(form);
        const data = {
            name: formData.get('name'),
            url: formData.get('url'),
            description: formData.get('description'),
            avatar: formData.get('avatar'),
        };

        submitBtn.disabled = true;
        submitBtn.textContent = '提交中...';

        try {
            const response = await fetch('/api/submit-friend-link', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });

            const result = await response.json();

            if (result.success) {
                showToast(result.message, 'success');

                // 关闭弹窗并重置表单
                setTimeout(() => {
                    document.getElementById('friend-link-modal').classList.add('hidden');
                    document.body.style.overflow = '';
                    form.reset();
                }, 500);
            } else {
                showToast(result.message, 'error');
            }
        } catch (error) {
            showToast('网络错误，请稍后重试', 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = '提交申请';
        }
    }
</script>
